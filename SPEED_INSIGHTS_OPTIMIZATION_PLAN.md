# Speed Insights æ€§èƒ½ä¼˜åŒ–ç»¼åˆæ–¹æ¡ˆ

> åŸºäº 2025-10-19 Speed Insights æŠ¥å‘Šçš„å…¨é¢æ€§èƒ½ä¼˜åŒ–è®¡åˆ’

## ğŸ“Š å½“å‰æ€§èƒ½è¯Šæ–­

### æ•´ä½“è¯„åˆ†
- **Real Experience Score (RES)**: 88åˆ† âš ï¸ **éœ€è¦æ”¹è¿›**
- **ç›®æ ‡**: æå‡è‡³ 90+ åˆ†ï¼ˆä¼˜ç§€ï¼‰

### æ ¸å¿ƒ Web Vitals æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|--------|--------|------|--------|
| **FCP** (é¦–æ¬¡å†…å®¹ç»˜åˆ¶) | 2.4s | < 1.8s | âš ï¸ éœ€ä¼˜åŒ– | ğŸ”´ é«˜ |
| **LCP** (æœ€å¤§å†…å®¹ç»˜åˆ¶) | 3.06s | < 2.5s | âš ï¸ éœ€ä¼˜åŒ– | ğŸ”´ é«˜ |
| **INP** (äº¤äº’å»¶è¿Ÿ) | 224ms | < 200ms | âš ï¸ éœ€ä¼˜åŒ– | ğŸŸ¡ ä¸­ |
| **CLS** (ç´¯ç§¯å¸ƒå±€åç§») | 0.01 | < 0.1 | âœ… ä¼˜ç§€ | ğŸŸ¢ ä½ |
| **FID** (é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ) | 4ms | < 100ms | âœ… ä¼˜ç§€ | ğŸŸ¢ ä½ |
| **TTFB** (é¦–å­—èŠ‚æ—¶é—´) | 0.74s | < 0.6s | ğŸŸ¡ è‰¯å¥½ | ğŸŸ¡ ä¸­ |

### è·¯ç”±æ€§èƒ½åˆ†æ

#### ğŸ”´ ä¸¥é‡é—®é¢˜è·¯ç”±

**1. `/archive` - RES: 66åˆ† (å·®)**
- è®¿é—®é‡: 43æ¬¡
- é—®é¢˜: æ€§èƒ½æœ€å·®çš„é¡µé¢
- å½±å“: ç”¨æˆ·ä½“éªŒå·®ï¼Œå¯èƒ½å¯¼è‡´è·³å‡ºç‡é«˜
- ä¼˜åŒ–æ½œåŠ›: **34åˆ†æå‡ç©ºé—´**

**2. `/posts/[slug]` - RES: 87åˆ† (éœ€æ”¹è¿›)**
- è®¿é—®é‡: 190æ¬¡ (æœ€é«˜æµé‡)
- é—®é¢˜: æ ¸å¿ƒå†…å®¹é¡µé¢æ€§èƒ½ä¸ä½³
- å½±å“: ç›´æ¥å½±å“ç”¨æˆ·é˜…è¯»ä½“éªŒ
- ä¼˜åŒ–æ½œåŠ›: **13åˆ†æå‡ç©ºé—´**

#### ğŸŸ¢ è‰¯å¥½è·¯ç”±

**3. `/` (é¦–é¡µ) - RES: 99åˆ† (ä¼˜ç§€)**
- è®¿é—®é‡: 44æ¬¡
- çŠ¶æ€: æ€§èƒ½ä¼˜ç§€ï¼Œä¿æŒç°çŠ¶

**4. `/friends` - RES: 99åˆ† (ä¼˜ç§€)**
- è®¿é—®é‡: 12æ¬¡
- çŠ¶æ€: æ€§èƒ½ä¼˜ç§€

**5. `/[page]` (åˆ†é¡µ) - RES: 100åˆ† (å®Œç¾)**
- è®¿é—®é‡: 6æ¬¡
- çŠ¶æ€: æ€§èƒ½å®Œç¾

### åœ°ç†ä½ç½®æ€§èƒ½åˆ†æ

| åœ°åŒº | è®¿é—®é‡ | RES | çŠ¶æ€ | ä¼˜åŒ–ä¼˜å…ˆçº§ |
|------|--------|-----|------|-----------|
| ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ | 126 (42%) | 74 | âš ï¸ å·® | ğŸ”´ æœ€é«˜ |
| ğŸ‡¨ğŸ‡³ ä¸­å›½ | 95 (31%) | 89 | ğŸŸ¡ éœ€æ”¹è¿› | ğŸŸ¡ é«˜ |
| ğŸ‡ºğŸ‡¸ ç¾å›½ | 18 (6%) | 72 | âš ï¸ å·® | ğŸŸ¡ ä¸­ |
| ğŸ‡¯ğŸ‡µ æ—¥æœ¬ | 13 (4%) | 80 | ğŸŸ¡ éœ€æ”¹è¿› | ğŸŸ¢ ä½ |

**å…³é”®å‘ç°**:
- 73%çš„æµé‡æ¥è‡ªæ–°åŠ å¡å’Œä¸­å›½
- æ–°åŠ å¡æ˜¯æœ€å¤§æµé‡æ¥æºä½†æ€§èƒ½æœ€å·®
- éœ€è¦é’ˆå¯¹äºšå¤ªåœ°åŒºä¼˜åŒ– CDN é…ç½®

---

## ğŸ¯ ä¼˜åŒ–ç­–ç•¥

### é˜¶æ®µä¸€: ç´§æ€¥ä¼˜åŒ– (1-2å‘¨) - ç›®æ ‡ RES: 90+

#### 1. ä¼˜åŒ– `/archive` è·¯ç”± (RES: 66 â†’ 90+)

**é—®é¢˜è¯Šæ–­**:
```typescript
// src/pages/archive.astro
const sortedPostsList = await getSortedPostsList();  // å¯èƒ½åŠ è½½æ‰€æœ‰æ–‡ç« æ•°æ®
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:

##### 1.1 å®æ–½è™šæ‹Ÿæ»šåŠ¨
```typescript
// src/components/ArchivePanel.svelte
// å½“å‰: ä¸€æ¬¡æ€§æ¸²æŸ“æ‰€æœ‰æ–‡ç« 
// ä¼˜åŒ–: ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼Œåªæ¸²æŸ“å¯è§åŒºåŸŸ

<script>
  import { onMount } from 'svelte';
  
  export let sortedPosts = [];
  
  let visiblePosts = [];
  let itemHeight = 80; // æ¯ä¸ªæ–‡ç« é¡¹é«˜åº¦
  let containerHeight = 600;
  let scrollTop = 0;
  
  $: {
    const startIndex = Math.floor(scrollTop / itemHeight);
    const endIndex = Math.min(
      startIndex + Math.ceil(containerHeight / itemHeight) + 5,
      sortedPosts.length
    );
    visiblePosts = sortedPosts.slice(startIndex, endIndex);
  }
</script>

<div 
  class="archive-container" 
  style="height: {containerHeight}px; overflow-y: auto;"
  on:scroll={(e) => scrollTop = e.target.scrollTop}
>
  <div style="height: {sortedPosts.length * itemHeight}px; position: relative;">
    {#each visiblePosts as post, i}
      <div style="position: absolute; top: {(startIndex + i) * itemHeight}px;">
        <!-- æ–‡ç« é¡¹å†…å®¹ -->
      </div>
    {/each}
  </div>
</div>
```

##### 1.2 æ•°æ®åˆ†é¡µåŠ è½½
```typescript
// src/pages/archive.astro
---
import ArchivePanel from "@components/ArchivePanel.svelte";
import { getSortedPostsList } from "../utils/content-utils";

// ä¼˜åŒ–: åªåŠ è½½å¿…è¦çš„å…ƒæ•°æ®ï¼Œä¸åŠ è½½å®Œæ•´å†…å®¹
const sortedPostsList = await getSortedPostsList();
const lightweightPosts = sortedPostsList.map(post => ({
  slug: post.slug,
  title: post.data.title,
  published: post.data.published,
  category: post.data.category,
  tags: post.data.tags?.slice(0, 3), // åªä¿ç•™å‰3ä¸ªæ ‡ç­¾
}));
---

<ArchivePanel sortedPosts={lightweightPosts} client:load></ArchivePanel>
```

##### 1.3 æ·»åŠ éª¨æ¶å±
```svelte
<!-- src/components/ArchivePanel.svelte -->
<script>
  let isLoading = true;
  
  onMount(() => {
    // æ¨¡æ‹Ÿæ•°æ®åŠ è½½
    setTimeout(() => isLoading = false, 100);
  });
</script>

{#if isLoading}
  <div class="skeleton-container">
    {#each Array(10) as _, i}
      <div class="skeleton-item animate-pulse">
        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
      </div>
    {/each}
  </div>
{:else}
  <!-- å®é™…å†…å®¹ -->
{/if}
```

**é¢„æœŸæ•ˆæœ**:
- LCP: 3.5s â†’ 2.0s (â†“ 43%)
- FCP: 2.8s â†’ 1.5s (â†“ 46%)
- RES: 66 â†’ 92+ (â†‘ 39%)

---

#### 2. ä¼˜åŒ– `/posts/[slug]` è·¯ç”± (RES: 87 â†’ 95+)

**é—®é¢˜è¯Šæ–­**:
```astro
<!-- src/pages/posts/[...slug].astro -->
<!-- é—®é¢˜1: Giscus è¯„è®ºç³»ç»Ÿé˜»å¡æ¸²æŸ“ -->
<script is:inline src="https://giscus.app/client.js" ...></script>

<!-- é—®é¢˜2: å›¾ç‰‡æœªä¼˜åŒ– -->
<ImageWrapper src={entry.data.image} priority={true}/>
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:

##### 2.1 å»¶è¿ŸåŠ è½½è¯„è®ºç³»ç»Ÿ
```astro
<!-- ä¼˜åŒ–å: ä½¿ç”¨ Intersection Observer å»¶è¿ŸåŠ è½½ -->
<div id="comments-container" class="card-base p-6 rounded-[var(--radius-large)] mb-4">
  <div id="giscus-placeholder" class="min-h-[200px] flex items-center justify-center">
    <button id="load-comments" class="btn-primary">
      åŠ è½½è¯„è®º
    </button>
  </div>
</div>

<script>
  function loadGiscus() {
    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', 'acleverfreebird/fuwari');
    script.setAttribute('data-repo-id', 'R_kgDOPbwShw');
    script.setAttribute('data-category', 'General');
    script.setAttribute('data-category-id', 'DIC_kwDOPbwSh84CuH7J');
    script.setAttribute('data-mapping', 'og:title');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'top');
    script.setAttribute('data-theme', 'preferred_color_scheme');
    script.setAttribute('data-lang', 'zh-CN');
    script.setAttribute('crossorigin', 'anonymous');
    script.async = true;
    
    const placeholder = document.getElementById('giscus-placeholder');
    placeholder.innerHTML = '';
    placeholder.appendChild(script);
  }

  // æ–¹æ¡ˆ1: ç”¨æˆ·ç‚¹å‡»åŠ è½½
  document.getElementById('load-comments')?.addEventListener('click', loadGiscus);

  // æ–¹æ¡ˆ2: æ»šåŠ¨åˆ°è¯„è®ºåŒºåŸŸè‡ªåŠ¨åŠ è½½
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        loadGiscus();
        observer.disconnect();
      }
    });
  }, { rootMargin: '200px' });

  const commentsContainer = document.getElementById('comments-container');
  if (commentsContainer) {
    observer.observe(commentsContainer);
  }
</script>
```

##### 2.2 ä¼˜åŒ–å›¾ç‰‡åŠ è½½ç­–ç•¥
```astro
<!-- src/pages/posts/[...slug].astro -->
{entry.data.image && (
  <ImageWrapper 
    id="post-cover" 
    src={entry.data.image} 
    basePath={path.join("content/posts/", getDir(entry.id))} 
    class="mb-8 rounded-xl banner-container onload-animation"
    priority={false}  <!-- æ”¹ä¸º falseï¼Œä½¿ç”¨æ‡’åŠ è½½ -->
    loading="lazy"
    decoding="async"
    fetchpriority="low"  <!-- é™ä½ä¼˜å…ˆçº§ -->
  />
)}
```

##### 2.3 é¢„è¿æ¥å…³é”®èµ„æº
```astro
<!-- åœ¨ <head> ä¸­æ·»åŠ  -->
<link slot="head" rel="preconnect" href="https://giscus.app" />
<link slot="head" rel="dns-prefetch" href="https://giscus.app" />
```

##### 2.4 ä¼˜åŒ–ä»£ç å—æ¸²æŸ“
```typescript
// astro.config.mjs
export default defineConfig({
  integrations: [
    expressiveCode({
      // æ·»åŠ ä»£ç å—æ‡’åŠ è½½
      themes: [expressiveCodeConfig.theme],
      plugins: [
        pluginCodeBlockCollapse({ 
          collapseAfter: 15,  // ä»20è¡Œé™ä½åˆ°15è¡Œ
          defaultCollapsed: true  // é»˜è®¤æŠ˜å 
        }),
        // ... å…¶ä»–æ’ä»¶
      ],
    }),
  ],
});
```

**é¢„æœŸæ•ˆæœ**:
- LCP: 3.2s â†’ 2.3s (â†“ 28%)
- INP: 240ms â†’ 180ms (â†“ 25%)
- RES: 87 â†’ 95+ (â†‘ 9%)

---

### é˜¶æ®µäºŒ: å…¨å±€æ€§èƒ½ä¼˜åŒ– (2-4å‘¨) - ç›®æ ‡ RES: 93+

#### 3. ä¼˜åŒ– LCP (3.06s â†’ 2.0s)

##### 3.1 ä¼˜åŒ– Banner å›¾ç‰‡
```astro
<!-- src/layouts/Layout.astro -->
<!-- å½“å‰é—®é¢˜: Banner å›¾ç‰‡å¯èƒ½è¿‡å¤§ -->

<!-- ä¼˜åŒ–æ–¹æ¡ˆ -->
<script>
  // 1. ä½¿ç”¨å“åº”å¼å›¾ç‰‡
  const banner = document.getElementById('banner');
  if (banner) {
    const img = banner.querySelector('img');
    if (img) {
      // æ ¹æ®è®¾å¤‡å®½åº¦åŠ è½½ä¸åŒå°ºå¯¸
      const width = window.innerWidth;
      let bannerSrc;
      
      if (width < 768) {
        bannerSrc = '/_astro/banner-mobile.webp';  // ç§»åŠ¨ç«¯: 800px
      } else if (width < 1200) {
        bannerSrc = '/_astro/banner-tablet.webp';  // å¹³æ¿: 1200px
      } else {
        bannerSrc = '/_astro/banner-desktop.webp'; // æ¡Œé¢: 1920px
      }
      
      img.src = bannerSrc;
    }
  }
</script>
```

##### 3.2 å›¾ç‰‡æ ¼å¼ä¼˜åŒ–
```bash
# ä½¿ç”¨ sharp æ‰¹é‡è½¬æ¢å›¾ç‰‡ä¸º WebP
npm install sharp-cli -g

# è½¬æ¢ banner å›¾ç‰‡
sharp -i src/assets/images/banner.png \
      -o public/_astro/banner-mobile.webp \
      --resize 800 \
      --webp '{"quality": 85}'

sharp -i src/assets/images/banner.png \
      -o public/_astro/banner-tablet.webp \
      --resize 1200 \
      --webp '{"quality": 85}'

sharp -i src/assets/images/banner.png \
      -o public/_astro/banner-desktop.webp \
      --resize 1920 \
      --webp '{"quality": 80}'
```

##### 3.3 å…³é”®èµ„æºé¢„åŠ è½½ä¼˜åŒ–
```astro
<!-- src/components/PerformanceOptimization.astro -->
<!-- å½“å‰: é¢„åŠ è½½å¯èƒ½ä¸å­˜åœ¨çš„èµ„æº -->
<link rel="preload" href="/_astro/banner.png" as="image" />

<!-- ä¼˜åŒ–: åªé¢„åŠ è½½å…³é”®èµ„æº -->
<link rel="preload" href="/_astro/banner-desktop.webp" as="image" type="image/webp" media="(min-width: 1200px)" />
<link rel="preload" href="/_astro/banner-tablet.webp" as="image" type="image/webp" media="(min-width: 768px) and (max-width: 1199px)" />
<link rel="preload" href="/_astro/banner-mobile.webp" as="image" type="image/webp" media="(max-width: 767px)" />

<!-- é¢„åŠ è½½å…³é”® CSS -->
<link rel="preload" href="/_astro/main.css" as="style" />

<!-- é¢„è¿æ¥å­—ä½“ CDN -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
```

**é¢„æœŸæ•ˆæœ**:
- LCP: 3.06s â†’ 2.0s (â†“ 35%)
- å›¾ç‰‡åŠ è½½æ—¶é—´: â†“ 60%

---

#### 4. ä¼˜åŒ– FCP (2.4s â†’ 1.6s)

##### 4.1 å†…è”å…³é”® CSS
```typescript
// astro.config.mjs
import { defineConfig } from 'astro/config';

export default defineConfig({
  build: {
    inlineStylesheets: 'always',  // ä» 'auto' æ”¹ä¸º 'always'
  },
  vite: {
    build: {
      cssCodeSplit: true,  // å¯ç”¨ CSS ä»£ç åˆ†å‰²
    },
  },
});
```

##### 4.2 æå–å…³é”® CSS
```html
<!-- src/layouts/Layout.astro -->
<head>
  <!-- å†…è”å…³é”® CSS -->
  <style>
    /* å…³é”®æ¸²æŸ“è·¯å¾„ CSS */
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--page-bg);
    }
    
    .card-base {
      background: var(--card-bg);
      border-radius: var(--radius-large);
    }
    
    /* éª¨æ¶å±æ ·å¼ */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
  
  <!-- å»¶è¿ŸåŠ è½½éå…³é”® CSS -->
  <link rel="preload" href="/_astro/main.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link rel="stylesheet" href="/_astro/main.css" /></noscript>
</head>
```

##### 4.3 ä¼˜åŒ–å­—ä½“åŠ è½½
```astro
<!-- src/layouts/Layout.astro -->
<head>
  <!-- ä¼˜åŒ–å­—ä½“åŠ è½½ç­–ç•¥ -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  
  <!-- ä½¿ç”¨ font-display: swap é¿å… FOIT -->
  <link 
    rel="stylesheet" 
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" 
    media="print" 
    onload="this.media='all'" 
  />
  <noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" />
  </noscript>
</head>

<style>
  /* å­—ä½“åŠ è½½æœŸé—´ä½¿ç”¨ç³»ç»Ÿå­—ä½“ */
  body {
    font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', 
                 'Helvetica Neue', Arial, sans-serif;
  }
</style>
```

**é¢„æœŸæ•ˆæœ**:
- FCP: 2.4s â†’ 1.6s (â†“ 33%)
- é¦–å±æ¸²æŸ“é€Ÿåº¦æå‡ 40%

---

#### 5. ä¼˜åŒ– INP (224ms â†’ 180ms)

##### 5.1 ä¼˜åŒ– JavaScript æ‰§è¡Œ
```typescript
// src/layouts/Layout.astro
<script>
  // å½“å‰: åŒæ­¥æ‰§è¡Œå¯èƒ½é˜»å¡ä¸»çº¿ç¨‹
  function initCustomScrollbar() {
    // ... å¤§é‡ DOM æ“ä½œ
  }
  
  // ä¼˜åŒ–: ä½¿ç”¨ requestIdleCallback å»¶è¿Ÿéå…³é”®åˆå§‹åŒ–
  function init() {
    loadTheme();
    loadHue();
    showBanner();
    
    // å»¶è¿Ÿåˆå§‹åŒ–æ»šåŠ¨æ¡
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => {
        initCustomScrollbar();
      }, { timeout: 2000 });
    } else {
      setTimeout(initCustomScrollbar, 100);
    }
  }
</script>
```

##### 5.2 ä¼˜åŒ–äº‹ä»¶ç›‘å¬å™¨
```typescript
// src/layouts/Layout.astro
<script>
  // å½“å‰: é¢‘ç¹çš„æ»šåŠ¨äº‹ä»¶å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜
  window.onscroll = scrollFunction;
  
  // ä¼˜åŒ–: ä½¿ç”¨èŠ‚æµ
  function throttle(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  window.onscroll = throttle(scrollFunction, 100);  // 100ms èŠ‚æµ
</script>
```

##### 5.3 ä¼˜åŒ– Svelte ç»„ä»¶
```svelte
<!-- src/components/ArchivePanel.svelte -->
<script>
  import { onMount, tick } from 'svelte';
  
  export let sortedPosts = [];
  
  // ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨å‡å°‘ DOM èŠ‚ç‚¹
  let visibleRange = { start: 0, end: 20 };
  
  // ä¼˜åŒ–: æ‰¹é‡æ›´æ–° DOM
  async function updateVisibleRange(newRange) {
    visibleRange = newRange;
    await tick();  // ç­‰å¾… DOM æ›´æ–°å®Œæˆ
  }
  
  // ä½¿ç”¨ IntersectionObserver è€Œä¸æ˜¯ scroll äº‹ä»¶
  onMount(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        // å¤„ç†å¯è§æ€§å˜åŒ–
      },
      { rootMargin: '100px' }
    );
    
    return () => observer.disconnect();
  });
</script>
```

**é¢„æœŸæ•ˆæœ**:
- INP: 224ms â†’ 180ms (â†“ 20%)
- äº¤äº’å“åº”é€Ÿåº¦æå‡ 25%

---

### é˜¶æ®µä¸‰: CDN å’Œåœ°ç†ä¼˜åŒ– (3-5å‘¨) - ç›®æ ‡ RES: 95+

#### 6. ä¼˜åŒ–äºšå¤ªåœ°åŒºæ€§èƒ½

##### 6.1 Vercel Edge Network é…ç½®
```json
// vercel.json
{
  "regions": [
    "sin1",  // æ–°åŠ å¡ (ä¸»è¦æµé‡)
    "hkg1",  // é¦™æ¸¯ (ä¸­å›½å¤§é™†é‚»è¿‘)
    "nrt1",  // ä¸œäº¬ (æ—¥æœ¬)
    "sfo1",  // æ—§é‡‘å±± (ç¾å›½è¥¿æµ·å²¸)
    "iad1"   // åç››é¡¿ (ç¾å›½ä¸œæµ·å²¸)
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, s-maxage=31536000, stale-while-revalidate=86400"
        },
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "SAMEORIGIN"
        },
        {
          "key": "Referrer-Policy",
          "value": "strict-origin-when-cross-origin"
        }
      ]
    },
    {
      "source": "/_astro/:path*",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, max-age=31536000, immutable"
        }
      ]
    },
    {
      "source": "/api/:path*",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, s-maxage=60, stale-while-revalidate=300"
        }
      ]
    }
  ]
}
```

##### 6.2 ä½¿ç”¨ Cloudflare CDN åŠ é€Ÿé™æ€èµ„æº
```typescript
// åˆ›å»º cloudflare-worker/static-assets-proxy.js
export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    
    // ç¼“å­˜ç­–ç•¥
    const cacheKey = new Request(url.toString(), request);
    const cache = caches.default;
    
    // å°è¯•ä»ç¼“å­˜è·å–
    let response = await cache.match(cacheKey);
    
    if (!response) {
      // ä»æºç«™è·å–
      response = await fetch(request);
      
      // åªç¼“å­˜æˆåŠŸçš„å“åº”
      if (response.ok) {
        // å…‹éš†å“åº”ä»¥ä¾¿ç¼“å­˜
        const responseToCache = response.clone();
        
        // è®¾ç½®ç¼“å­˜å¤´
        const headers = new Headers(responseToCache.headers);
        headers.set('Cache-Control', 'public, max-age=31536000');
        headers.set('CDN-Cache-Control', 'public, max-age=31536000');
        
        const cachedResponse = new Response(responseToCache.body, {
          status: responseToCache.status,
          statusText: responseToCache.statusText,
          headers: headers
        });
        
        // å¼‚æ­¥ç¼“å­˜
        await cache.put(cacheKey, cachedResponse);
      }
    }
    
    return response;
  }
};
```

##### 6.3 ä¼˜åŒ– Umami Analytics åŠ è½½
```astro
<!-- src/components/UmamiAnalytics.astro -->
---
import { umamiConfig } from '@/config';
---

{umamiConfig.enable && (
  <script 
    defer  <!-- ä½¿ç”¨ defer è€Œä¸æ˜¯ async -->
    data-website-id={umamiConfig.websiteId}
    data-domains={umamiConfig.domains}
    data-auto-track={umamiConfig.autoTrack}
  >
    // å»¶è¿ŸåŠ è½½ Umami
    (function() {
      const loadUmami = () => {
        const script = document.createElement('script');
        script.src = '{umamiConfig.src}';
        script.defer = true;
        script.setAttribute('data-website-id', '{umamiConfig.websiteId}');
        script.setAttribute('data-domains', '{umamiConfig.domains}');
        script.setAttribute('data-auto-track', '{umamiConfig.autoTrack}');
        document.head.appendChild(script);
      };
      
      // é¡µé¢åŠ è½½å®Œæˆåå»¶è¿ŸåŠ è½½
      if (document.readyState === 'complete') {
        setTimeout(loadUmami, {umamiConfig.delayLoad || 2000});
      } else {
        window.addEventListener('load', () => {
          setTimeout(loadUmami, {umamiConfig.delayLoad || 2000});
        });
      }
    })();
  </script>
)}
```

**é¢„æœŸæ•ˆæœ**:
- æ–°åŠ å¡ RES: 74 â†’ 90+ (â†‘ 22%)
- ä¸­å›½ RES: 89 â†’ 95+ (â†‘ 7%)
- TTFB: 0.74s â†’ 0.5s (â†“ 32%)

---

### é˜¶æ®µå››: é«˜çº§ä¼˜åŒ– (æŒç»­ä¼˜åŒ–)

#### 7. å®æ–½ Service Worker ç¼“å­˜ç­–ç•¥

```javascript
// public/sw.js
const CACHE_VERSION = 'v2';
const STATIC_CACHE = `static-${CACHE_VERSION}`;
const DYNAMIC_CACHE = `dynamic-${CACHE_VERSION}`;
const IMAGE_CACHE = `images-${CACHE_VERSION}`;

// éœ€è¦é¢„ç¼“å­˜çš„é™æ€èµ„æº
const STATIC_ASSETS = [
  '/',
  '/offline/',
  '/_astro/main.css',
  '/_astro/banner-desktop.webp',
];

// å®‰è£…äº‹ä»¶ - é¢„ç¼“å­˜é™æ€èµ„æº
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(STATIC_CACHE).then((cache) => {
      return cache.addAll(STATIC_ASSETS);
    })
  );
  self.skipWaiting();
});

// æ¿€æ´»äº‹ä»¶ - æ¸…ç†æ—§ç¼“å­˜
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames
          .filter((name) => name.startsWith('static-') || name.startsWith('dynamic-') || name.startsWith('images-'))
          .filter((name) => name !== STATIC_CACHE && name !== DYNAMIC_CACHE && name !== IMAGE_CACHE)
          .map((name) => caches.delete(name))
      );
    })
  );
  self.clients.claim();
});

// Fetch äº‹ä»¶ - ç¼“å­˜ç­–ç•¥
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);

  // è·³è¿‡é GET è¯·æ±‚
  if (request.method !== 'GET') return;

  // è·³è¿‡ Chrome æ‰©å±•è¯·æ±‚
  if (url.protocol === 'chrome-extension:') return;

  // API è¯·æ±‚ - Network First
  if (url.pathname.startsWith('/api/')) {
    event.respondWith(networkFirst(request, DYNAMIC_CACHE));
    return;
  }

  // å›¾ç‰‡è¯·æ±‚ - Cache First
  if (request.destination === 'image') {
    event.respondWith(cacheFirst(request, IMAGE_CACHE));
    return;
  }

  // é™æ€èµ„æº - Cache First
  if (url.pathname.startsWith('/_astro/')) {
    event.respondWith(cacheFirst(request, STATIC_CACHE));
    return;
  }

  // HTML é¡µé¢ - Network First with Cache Fallback
  if (request.destination === 'document') {
    event.respondWith(networkFirst(request, DYNAMIC_CACHE));
    return;
  }

  // å…¶ä»–è¯·æ±‚ - Network First
  event.respondWith(networkFirst(request, DYNAMIC_CACHE));
});

// Cache First ç­–ç•¥
async function cacheFirst(request, cacheName) {
  const cache = await caches.open(cacheName);
  const cached = await cache.match(request);
  
  if (cached) {
    return cached;
  }

  try {
    const response = await fetch(request);
    if (response.ok) {
      cache.put(request, response.clone());
    }
    return response;
  } catch (error) {
    console.error('Fetch failed:', error);
    throw error;
  }
}

// Network First ç­–ç•¥
async function networkFirst(request, cacheName) {
  const cache = await caches.open(cacheName);
  
  try {
    const response = await fetch(request);
    if (response.ok) {
      cache.put(request, response.clone());
    }
    return response;
  } catch (error) {
    const cached = await cache.match(request);
    if (cached) {
      return cached;
    }
    
    // å¦‚æœæ˜¯ HTML è¯·æ±‚ä¸”ç¼“å­˜æœªå‘½ä¸­ï¼Œè¿”å›ç¦»çº¿é¡µé¢
    if (request.destination === 'document') {
      return cache.match('/offline/');
    }
    
    throw error;
  }
}
```

##### 7.1 æ³¨å†Œ Service Worker
```astro
<!-- src/layouts/Layout.astro -->
<script>
  // æ³¨å†Œ Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
          console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
          
          // æ£€æŸ¥æ›´æ–°
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæç¤ºç”¨æˆ·åˆ·æ–°
                if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦åˆ·æ–°é¡µé¢ï¼Ÿ')) {
                  window.location.reload();
                }
              }
            });
          });
        })
        .catch((error) => {
          console.error('âŒ Service Worker æ³¨å†Œå¤±è´¥:', error);
        });
    });
  }
</script>
```

**é¢„æœŸæ•ˆæœ**:
- é‡å¤è®¿é—®é€Ÿåº¦æå‡ 70%
- ç¦»çº¿è®¿é—®æ”¯æŒ
- å‡å°‘æœåŠ¡å™¨è¯·æ±‚ 50%

---

#### 8. å®æ–½èµ„æºä¼˜å…ˆçº§ä¼˜åŒ–

```astro
<!-- src/layouts/Layout.astro -->
<head>
  <!-- å…³é”®èµ„æº - æœ€é«˜ä¼˜å…ˆçº§ -->
  <link rel="preload" href="/_astro/main.css" as="style" fetchpriority="high" />
  <link rel="preload" href="/_astro/banner-desktop.webp" as="image" fetchpriority="high" />
  
  <!-- å­—ä½“ - é«˜ä¼˜å…ˆçº§ -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link 
    rel="preload" 
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" 
    as="style" 
    fetchpriority="high"
  />
  
  <!-- åˆ†æè„šæœ¬ - ä½ä¼˜å…ˆçº§ -->
  <link rel="preconnect" href="https://views.freebird2913.tech" />
  <link rel="dns-prefetch" href="https://www.clarity.ms" />
  
  <!-- ç¬¬ä¸‰æ–¹èµ„æº - æœ€ä½ä¼˜å…ˆçº§ -->
  <link rel="preconnect" href="https://giscus.app" fetchpriority="low" />
</head>

<body>
  <!-- å…³é”®å†…å®¹ - é«˜ä¼˜å…ˆçº§ -->
  <img src="/banner.webp" fetchpriority="high" loading="eager" />
  
  <!-- éå…³é”®å›¾ç‰‡ - ä½ä¼˜å…ˆçº§ -->
  <img src="/avatar.webp" fetchpriority="low" loading="lazy" />
</body>
```

---

## ğŸ“ˆ é¢„æœŸæ€§èƒ½æå‡æ€»è§ˆ

### æ ¸å¿ƒæŒ‡æ ‡æ”¹å–„

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æ”¹å–„å¹…åº¦ |
|------|------|------|----------|
| **RES** | 88 | 95+ | â†‘ 8% |
| **FCP** | 2.4s | 1.6s | â†“ 33% |
| **LCP** | 3.06s | 2.0s | â†“ 35% |
| **INP** | 224ms | 180ms | â†“ 20% |
| **TTFB** | 0.74s | 0.5s | â†“ 32% |

### è·¯ç”±æ€§èƒ½æ”¹å–„

| è·¯ç”± | å½“å‰ RES | ç›®æ ‡ RES | æ”¹å–„ |
|------|----------|----------|------|
| `/archive` | 66 | 92+ | â†‘ 39% |
| `/posts/[slug]` | 87 | 95+ | â†‘ 9% |
| `/` | 99 | 99 | ä¿æŒ |

### åœ°ç†ä½ç½®æ”¹å–„

| åœ°åŒº | å½“å‰ RES | ç›®æ ‡ RES | æ”¹å–„ |
|------|----------|----------|------|
| æ–°åŠ å¡ | 74 | 90+ | â†‘ 22% |
| ä¸­å›½ | 89 | 95+ | â†‘ 7% |
| ç¾å›½ | 72 | 88+ | â†‘ 22% |
| æ—¥æœ¬ | 80 | 92+ | â†‘ 15% |

---

## ğŸ” ç›‘æ§å’ŒéªŒè¯

### æ€§èƒ½ç›‘æ§å·¥å…·

#### 1. å®æ—¶ç›‘æ§
```typescript
// src/components/PerformanceMonitor.astro
<script>
  // Web Vitals ç›‘æ§
  import { onCLS, onFCP, onFID, onINP, onLCP, onTTFB } from 'web-vitals';

  function sendToAnalytics(metric) {
    // å‘é€åˆ° Umami æˆ–å…¶ä»–åˆ†ææœåŠ¡
    if (window.umami) {
      window.umami.track('web-vitals', {
        metric: metric.name,
        value: Math.round(metric.value),
        rating: metric.rating,
      });
    }
    
    console.log(`ğŸ“Š ${metric.name}:`, {
      value: metric.value,
      rating: metric.rating,
      delta: metric.delta,
    });
  }

  onCLS(sendToAnalytics);
  onFCP(sendToAnalytics);
  onFID(sendToAnalytics);
  onINP(sendToAnalytics);
  onLCP(sendToAnalytics);
  onTTFB(sendToAnalytics);
</script>
```

#### 2. Lighthouse CI é›†æˆ
```yaml
# .github/workflows/lighthouse-ci.yml
name: Lighthouse CI
on: [push, pull_request]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            https://www.freebird2913.tech/
            https://www.freebird2913.tech/archive/
            https://www.freebird2913.tech/posts/first/
          uploadArtifacts: true
          temporaryPublicStorage: true
```

#### 3. æ€§èƒ½é¢„ç®—
```json
// lighthouse-budget.json
{
  "budgets": [
    {
      "path": "/*",
      "timings": [
        {
          "metric": "first-contentful-paint",
          "budget": 1800
        },
        {
          "metric": "largest-contentful-paint",
          "budget": 2500
        },
        {
          "metric": "interactive",
          "budget": 3800
        }
      ],
      "resourceSizes": [
        {
          "resourceType": "script",
          "budget": 300
        },
        {
          "resourceType": "stylesheet",
          "budget": 100
        },
        {
          "resourceType": "image",
          "budget": 500
        },
        {
          "resourceType": "total",
          "budget": 1000
        }
      ]
    }
  ]
}
```

---

## ğŸš€ å®æ–½æ—¶é—´è¡¨

### ç¬¬ 1-2 å‘¨: ç´§æ€¥ä¼˜åŒ–
- [x] ä¼˜åŒ– `/archive` è·¯ç”±
  - [ ] å®æ–½è™šæ‹Ÿæ»šåŠ¨
  - [ ] æ•°æ®åˆ†é¡µåŠ è½½
  - [ ] æ·»åŠ éª¨æ¶å±
- [x] ä¼˜åŒ– `/posts/[slug]` è·¯ç”±
  - [ ] å»¶è¿ŸåŠ è½½è¯„è®ºç³»ç»Ÿ
  - [ ] ä¼˜åŒ–å›¾ç‰‡åŠ è½½
  - [ ] ä¼˜åŒ–ä»£ç å—æ¸²æŸ“

**é‡Œç¨‹ç¢‘**: RES æå‡è‡³ 90+

### ç¬¬ 3-4 å‘¨: å…¨å±€ä¼˜åŒ–
- [ ] ä¼˜åŒ– LCP
  - [ ] Banner å›¾ç‰‡ä¼˜åŒ–
  - [ ] å“åº”å¼å›¾ç‰‡
  - [ ] å…³é”®èµ„æºé¢„åŠ è½½
- [ ] ä¼˜åŒ– FCP
  - [ ] å†…è”å…³é”® CSS
  - [ ] ä¼˜åŒ–å­—ä½“åŠ è½½
- [ ] ä¼˜åŒ– INP
  - [ ] JavaScript æ‰§è¡Œä¼˜åŒ–
  - [ ] äº‹ä»¶ç›‘å¬å™¨ä¼˜åŒ–

**é‡Œç¨‹ç¢‘**: RES æå‡è‡³ 93+

### ç¬¬ 5-6 å‘¨: CDN ä¼˜åŒ–
- [ ] Vercel Edge Network é…ç½®
- [ ] Cloudflare CDN é›†æˆ
- [ ] ä¼˜åŒ– Analytics åŠ è½½

**é‡Œç¨‹ç¢‘**: äºšå¤ªåœ°åŒº RES æå‡è‡³ 90+

### ç¬¬ 7-8 å‘¨: é«˜çº§ä¼˜åŒ–
- [ ] Service Worker å®æ–½
- [ ] èµ„æºä¼˜å…ˆçº§ä¼˜åŒ–
- [ ] æ€§èƒ½ç›‘æ§é›†æˆ

**é‡Œç¨‹ç¢‘**: æ•´ä½“ RES æå‡è‡³ 95+

---

## âœ… éªŒè¯æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] æ‰€æœ‰å›¾ç‰‡å·²è½¬æ¢ä¸º WebP æ ¼å¼
- [ ] å…³é”® CSS å·²å†…è”
- [ ] Service Worker å·²æ³¨å†Œ
- [ ] æ€§èƒ½ç›‘æ§å·²é…ç½®
- [ ] Lighthouse è¯„åˆ† > 90

### éƒ¨ç½²åéªŒè¯
- [ ] æ‰€æœ‰è·¯ç”± RES > 90
- [ ] FCP < 1.8s
- [ ] LCP < 2.5s
- [ ] INP < 200ms
- [ ] TTFB < 0.6s
- [ ] æ–°åŠ å¡ RES > 90
- [ ] ä¸­å›½ RES > 95

---

## ğŸ“š å‚è€ƒèµ„æº

- [Web Vitals](https://web.dev/vitals/)
- [Vercel Speed Insights](https://vercel.com/docs/speed-insights)
- [Lighthouse Performance Scoring](https://web.dev/performance-scoring/)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Resource Hints](https://www.w3.org/TR/resource-hints/)

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-19  
**æœ€åæ›´æ–°**: 2025-10-19  
**çŠ¶æ€**: ğŸ“‹ å¾…å®¡æ ¸ â†’ å‡†å¤‡å®æ–½