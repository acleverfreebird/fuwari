<div id="waline" class="mx-auto mt-10 w-full transition-colors duration-300"></div>

<script is:inline>
  // 常量定义 - 与主题系统保持一致
  const LIGHT_MODE = "light";
  const DARK_MODE = "dark";
  const AUTO_MODE = "auto";
  const DEFAULT_THEME = AUTO_MODE;

  // 获取当前实际主题状态（考虑自动模式）
  function getCurrentActualTheme() {
    const storedTheme = localStorage.getItem("theme") || DEFAULT_THEME;
    
    if (storedTheme === AUTO_MODE) {
      return window.matchMedia("(prefers-color-scheme: dark)").matches ? DARK_MODE : LIGHT_MODE;
    }
    return storedTheme;
  }

  // 获取 Waline 主题配置
  function getWalineTheme() {
    const currentTheme = getCurrentActualTheme();
    return currentTheme === DARK_MODE ? "dark" : "light";
  }

  // 更新 Waline 主题
  function updateWalineTheme() {
    if (window.walineInstance) {
      const theme = getWalineTheme();
      try {
        window.walineInstance.update({
          dark: theme === "dark"
        });
        console.log(`Waline theme updated to: ${theme}`);
      } catch (error) {
        console.warn("Failed to update Waline theme:", error);
      }
    }
  }

  // 加载 Waline 评论组件
  async function loadWaline() {
    // 防止重复加载
    if (window.walineLoaded) {
      return;
    }

    // 动态加载 Waline CSS
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "https://unpkg.com/@waline/client@v3/dist/waline.css";
    document.head.appendChild(link);

    try {
      // 使用动态 import 加载 Waline
      const { init } = await import("https://unpkg.com/@waline/client@v3/dist/waline.js");
      
      console.log("Waline script loaded");
      window.walineLoaded = true;

      // 初始化 Waline
      const currentTheme = getWalineTheme();
      window.walineInstance = init({
        el: "#waline",
        serverURL: "https://waline.freebird2913.tech/",
        lang: "zh-CN",
        dark: currentTheme === "dark",
        meta: ["nick", "mail", "link"],
        requiredMeta: ["nick"],
        pageSize: 10,
        wordLimit: [0, 1000],
        emoji: [
          "https://unpkg.com/@waline/emojis@1.2.0/weibo",
          "https://unpkg.com/@waline/emojis@1.2.0/alus",
          "https://unpkg.com/@waline/emojis@1.2.0/bilibili",
        ],
        search: false,
        pageview: true,
        comment: true,
        copyright: true,
        login: "enable",
      });
      console.log("Waline initialized");
    } catch (error) {
      console.error("Failed to load Waline script:", error);
    }
  }

  // 监听主题变化事件
  function setupThemeChangeListener() {
    // 监听存储变化（主要用于多标签页同步）
    window.addEventListener("storage", (event) => {
      if (event.key === "theme") {
        updateWalineTheme();
      }
    });

    // 监听系统主题偏好变化（用于自动模式）
    const darkModeMediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
    const handleSystemThemeChange = () => {
      const storedTheme = localStorage.getItem("theme") || DEFAULT_THEME;
      if (storedTheme === AUTO_MODE) {
        updateWalineTheme();
      }
    };
    
    // 使用现代 addEventListener 方法
    darkModeMediaQuery.addEventListener("change", handleSystemThemeChange);

    // 监听自定义主题变化事件（与主题切换组件配合）
    document.addEventListener("themeChanged", () => {
      setTimeout(() => updateWalineTheme(), 100);
    });
  }

  // 初始化函数
  function initWalineComments() {
    // 确保主题状态在页面刷新后正确应用
    const currentTheme = getCurrentActualTheme();
    const documentHasDarkClass = document.documentElement.classList.contains("dark");
    const shouldBeDark = currentTheme === DARK_MODE;

    // 修复可能的主题状态不一致
    if (shouldBeDark && !documentHasDarkClass) {
      document.documentElement.classList.add("dark");
    } else if (!shouldBeDark && documentHasDarkClass) {
      document.documentElement.classList.remove("dark");
    }

    // 设置主题监听器
    setupThemeChangeListener();

    // 加载 Waline
    loadWaline();
  }

  // 页面加载时初始化
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initWalineComments);
  } else {
    initWalineComments();
  }

  // 导出全局函数供外部调用
  window.updateWalineTheme = updateWalineTheme;
</script>