---
import { Icon } from "astro-icon/components";
/**
 * Umami æµè§ˆé‡æ˜¾ç¤ºç»„ä»¶
 * æ”¯æŒæ˜¾ç¤ºæ€»æµè§ˆé‡å’Œå•é¡µæµè§ˆé‡
 */
import { umamiStatsConfig } from "@/config";

interface Props {
	type?: "total" | "page"; // æ˜¾ç¤ºç±»å‹: total=æ€»æµè§ˆé‡, page=é¡µé¢æµè§ˆé‡
	url?: string; // é¡µé¢URL (type=pageæ—¶å¿…éœ€)
	showVisitors?: boolean; // æ˜¯å¦æ˜¾ç¤ºè®¿é—®è€…æ•°é‡
	class?: string;
}

const {
	type = "total",
	url,
	showVisitors = true,
	class: className,
} = Astro.props;

// å¦‚æœæœªå¯ç”¨ç»Ÿè®¡åŠŸèƒ½,ä¸æ¸²æŸ“ç»„ä»¶
if (!umamiStatsConfig.enable) {
	return null;
}

// å¦‚æœæ˜¯é¡µé¢æµè§ˆé‡ä½†æœªæä¾›URL,ä¸æ¸²æŸ“
if (type === "page" && !url) {
	console.warn("UmamiPageViews: type='page' requires url prop");
	return null;
}

// ç”Ÿæˆå”¯ä¸€IDç”¨äºDOMæ“ä½œ
const componentId = `umami-views-${Math.random().toString(36).substr(2, 9)}`;
---

<div class:list={["umami-page-views", className]} id={componentId} data-type={type} data-url={url} data-show-visitors={showVisitors}>
	<div class="stat-item pageviews-item">
		<span class="label">æµè§ˆé‡:</span>
		<span class="views-count">
			<span class="loading">...</span>
			<span class="count" style="display: none;">0</span>
			<span class="error" style="display: none;">--</span>
		</span>
	</div>
	<div class="stat-item visitors-item" style={showVisitors ? "" : "display: none !important;"}>
		<span class="label">è®¿å®¢æ•°é‡:</span>
		<span class="visitors-count">
			<span class="count">0</span>
		</span>
	</div>
</div>

<script>
	import { umamiStatsConfig } from "@/config";

	interface ViewsData {
		pageviews?: number;
		total?: number;  // æ€»æµè§ˆé‡ä½¿ç”¨ total å­—æ®µ
		visitors?: number;
		error?: string;
	}

	// å…¨å±€ AbortController ç”¨äºå–æ¶ˆè¯·æ±‚
	let abortController: AbortController | null = null;

	/**
	 * æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
	 */
	function formatNumber(num: number): string {
		return num.toString();
	}

	/**
	 * è·å–æµè§ˆé‡æ•°æ®
	 */
	async function fetchPageViews(type: string, url?: string): Promise<ViewsData> {
		try {
			// å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
			if (abortController) {
				abortController.abort();
			}
			
			// åˆ›å»ºæ–°çš„ AbortController
			abortController = new AbortController();
			
			let apiUrl = `${umamiStatsConfig.apiUrl}/stats/total`;
			if (type === "page" && url) {
				apiUrl = `${umamiStatsConfig.apiUrl}/stats/page?url=${encodeURIComponent(url)}`;
			}

			const response = await fetch(apiUrl, {
				signal: abortController.signal,
				headers: {
					'Accept': 'application/json',
				}
			});
			
			if (!response.ok) {
				throw new Error(`HTTP ${response.status}`);
			}

			const data = await response.json();
			return data;
		} catch (error) {
			// å¿½ç•¥ä¸­æ–­é”™è¯¯,ä¸åœ¨æ§åˆ¶å°æ˜¾ç¤º
			if (error instanceof Error && error.name === 'AbortError') {
				return { error: 'Request cancelled' };
			}
			console.error("Failed to fetch Umami page views:", error);
			return { error: (error as Error).message };
		}
	}

	/**
	 * æ›´æ–°æ˜¾ç¤º
	 */
	function updateDisplay(
		container: HTMLElement,
		data: ViewsData,
	) {
		const showVisitors = container.getAttribute("data-show-visitors") === "true";
		const pageviewsItem = container.querySelector(".pageviews-item") as HTMLElement;
		const loadingEl = pageviewsItem?.querySelector(".loading") as HTMLElement;
		const countEl = pageviewsItem?.querySelector(".count") as HTMLElement;
		const errorEl = pageviewsItem?.querySelector(".error") as HTMLElement;

		console.log("ğŸ” Complete API Response:", JSON.stringify(data, null, 2));
		console.log("ğŸ” All data keys:", Object.keys(data));
		console.log("ğŸ” showVisitors:", showVisitors);

		if (loadingEl) loadingEl.style.display = "none";

		if (data.error) {
			console.error("Umami stats error:", data.error);
			if (errorEl) {
				errorEl.style.display = "inline";
			}
			return;
		}

		// æ›´æ–°æµè§ˆé‡ (æ”¯æŒ pageviews å’Œ total ä¸¤ç§å­—æ®µ)
		const viewCount = data.pageviews ?? data.total;
		console.log("ğŸ” Extracted viewCount:", viewCount, "from pageviews:", data.pageviews, "total:", data.total);
		
		if (viewCount !== undefined && countEl) {
			countEl.textContent = formatNumber(viewCount);
			countEl.style.display = "inline";
			console.log("âœ… Updated pageviews:", viewCount, "->", countEl.textContent);
		} else {
			console.warn("âŒ No pageviews/total data or countEl missing:", { data, countEl });
		}

		// æ›´æ–°è®¿é—®è€…æ•°é‡
		console.log("ğŸ” Checking visitors - showVisitors:", showVisitors, "data.visitors:", data.visitors);
		if (showVisitors && data.visitors !== undefined) {
			const visitorsItem = container.querySelector(".visitors-item") as HTMLElement;
			const visitorsCountEl = visitorsItem?.querySelector(".count") as HTMLElement;
			
			console.log("ğŸ” Visitors elements:", { visitorsItem, visitorsCountEl });
			
			if (visitorsItem && visitorsCountEl) {
				visitorsCountEl.textContent = formatNumber(data.visitors);
				visitorsItem.style.display = "flex";
				console.log("âœ… Updated visitors:", data.visitors, "->", visitorsCountEl.textContent);
			}
		} else {
			console.log("âš ï¸ Visitors not shown - showVisitors:", showVisitors, "visitors value:", data.visitors);
		}
	}

	/**
	 * åˆå§‹åŒ–ç»„ä»¶
	 */
	function initUmamiPageViews() {
		if (!umamiStatsConfig.enable) return;

		const containers = document.querySelectorAll(".umami-page-views");
		containers.forEach(async (container) => {
			const type = container.getAttribute("data-type") || "total";
			const url = container.getAttribute("data-url") || undefined;

			const data = await fetchPageViews(type, url);
			updateDisplay(container as HTMLElement, data);
		});
	}

	// æ¸…ç†å‡½æ•°
	function cleanup() {
		if (abortController) {
			abortController.abort();
			abortController = null;
		}
	}

	// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initUmamiPageViews);
	} else {
		initUmamiPageViews();
	}

	// æ”¯æŒé¡µé¢å¯¼èˆªåé‡æ–°åŠ è½½ (SPAæ¨¡å¼)
	document.addEventListener("astro:page-load", initUmamiPageViews);
	
	// é¡µé¢å¸è½½å‰æ¸…ç†è¯·æ±‚
	document.addEventListener("astro:before-swap", cleanup);
</script>

<style>
	.umami-page-views {
		display: inline-flex;
		align-items: center;
		gap: 1.5rem;
		font-size: 0.875rem;
		color: var(--color-text-secondary, #666);
	}

	.stat-item {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
	}

	.label {
		font-size: 0.875rem;
		opacity: 0.9;
		font-weight: 500;
	}

	.views-count,
	.visitors-count {
		font-variant-numeric: tabular-nums;
		font-weight: 600;
		color: var(--color-text-primary, #333);
	}

	.loading {
		opacity: 0.6;
		font-size: 0.75rem;
	}

	.error {
		opacity: 0.4;
	}

	/* æ·±è‰²æ¨¡å¼æ”¯æŒ */
	:global(.dark) .umami-page-views {
		color: var(--color-text-secondary-dark, #999);
	}

	:global(.dark) .views-count,
	:global(.dark) .visitors-count {
		color: var(--color-text-primary-dark, #eee);
	}
</style>